services:
  # ===== Login DB =====
  login-db:
    image: mysql:8.0
    container_name: login-db
    environment:
      MYSQL_ROOT_PASSWORD: rootpw
      MYSQL_DATABASE: authdb
      MYSQL_USER: authuser
      MYSQL_PASSWORD: authpw
    ports:
      - "3307:3306"
    volumes:
      - login_db_data:/var/lib/mysql
      - ../services/login-db/init:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "127.0.0.1", "-u", "authuser", "-pauthpw"]
      interval: 5s
      timeout: 3s
      retries: 20

  # ===== Login Service (SCALABLE) =====
  # NOTE: no container_name, no host ports
  login-service:
    build:
      context: ..
      dockerfile: services/login-service/Dockerfile
    expose:
      - "50051"
    environment:
      DB_HOST: login-db
      DB_PORT: 3306
      DB_USER: authuser
      DB_PASSWORD: authpw
      DB_NAME: authdb
      TOKEN_TTL_MINUTES: 60
    depends_on:
      login-db:
        condition: service_healthy

  # ===== Chatroom DB =====
  chatroom-db:
    image: mysql:8.0
    container_name: chatroom-db
    environment:
      MYSQL_ROOT_PASSWORD: rootpw
      MYSQL_DATABASE: chatdb
      MYSQL_USER: chatuser
      MYSQL_PASSWORD: chatpw
    ports:
      - "3308:3306"
    volumes:
      - chatroom_db_data:/var/lib/mysql
      - ../services/chatroom-db/init:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "127.0.0.1", "-u", "chatuser", "-pchatpw"]
      interval: 5s
      timeout: 3s
      retries: 20

  # ===== Chatroom Service (single instance is fine; you can scale later if needed) =====
  chatroom-service:
    build:
      context: ..
      dockerfile: services/chatroom-service/Dockerfile
    expose:
      - "50053"
    environment:
      DB_HOST: chatroom-db
      DB_PORT: 3306
      DB_USER: chatuser
      DB_PASSWORD: chatpw
      DB_NAME: chatdb
    depends_on:
      chatroom-db:
        condition: service_healthy

  # ===== Chat Service (messaging) (SCALABLE) =====
  # NOTE: no container_name, no host ports
  chat-service:
    build:
      context: ../services/chat-service
      dockerfile: Dockerfile
    expose:
      - "50054"
    environment:
      PORT: 50054
      DB_HOST: chatroom-db
      DB_PORT: 3306
      DB_USER: chatuser
      DB_PASSWORD: chatpw
      DB_NAME: chatdb
    volumes:
      - ../contracts:/contracts:ro
    depends_on:
      chatroom-db:
        condition: service_healthy

  # ===== Gateway Service (SCALABLE) =====
  # IMPORTANT: remove host port mapping to allow replicas
  gateway-service:
    build:
      context: ..
      dockerfile: services/gateway-service/Dockerfile
    expose:
      - "50052"
    environment:
      LOGIN_HOST: login-service
      LOGIN_PORT: 50051
      CHAT_HOST: chatroom-service
      CHAT_PORT: 50053
      CHATMSG_HOST: chat-service
      CHATMSG_PORT: 50054
    depends_on:
      - login-service
      - chatroom-service
      - chat-service

  # ===== Envoy gRPC load balancer (stable entrypoint for tester) =====
  # Exposes ports ONCE. Routes to multiple replicas via service DNS.
  grpc-lb:
    image: envoyproxy/envoy:v1.30-latest
    container_name: grpc-lb
    volumes:
      - ./envoy.yaml:/etc/envoy/envoy.yaml:ro
    ports:
      - "50051:50051"  # login
      - "50052:50052"  # gateway
      - "9901:9901"    # envoy admin (optional)
    depends_on:
      - login-service
      - gateway-service

  # ===== Tester =====
  tester-service:
    build:
      context: ..
      dockerfile: services/tester-service/Dockerfile
    depends_on:
      - grpc-lb
      - chat-service
      - chatroom-service
      - login-service
    environment:
      # Keep your legacy defaults (if used somewhere)
      - SCENARIO=${SCENARIO:-1}
      - USER_COUNT=${USER_COUNT:-5}

      # Also set perf-harness style vars (used by your newer scenarios)
      - USERS_TOTAL=${USERS_TOTAL:-10}
      - shard_count=${shard_count:-1}
      - shard_index=${shard_index:-0}
      - duration_sec=${duration_sec:-120}
      - msg_rate_per_user_per_sec=${msg_rate_per_user_per_sec:-0.2}

      # Force tester to use the load balancer (stable endpoints)
      - login_addr=grpc-lb:50051
      - gateway_addr=grpc-lb:50052
      - LOGIN_ADDR=grpc-lb:50051
      - GATEWAY_ADDR=grpc-lb:50052

volumes:
  login_db_data:
  chatroom_db_data: